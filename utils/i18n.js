const settings = require('./settings.js')

const DICT = {
  zh: {
    'calendar.today': '今天',
    'calendar.pickTitle': '选择心情',
    'calendar.addNote': '添加备注',
    'calendar.clear': '清除',
    'calendar.stats': '统计',
    'calendar.settings': '设置',
    'calendar.search': '搜索',
    'calendar.lockedTitle': '数据已加密',
    'calendar.lockedHint': '请在设置中解锁本地数据后查看日历。',
    'calendar.unlock': '去设置解锁',
    'calendar.accessibilityPrevMonth': '上一月',
    'calendar.accessibilityNextMonth': '下一月',
    'calendar.accessibilityMonthPicker': '选择月份',

    'detail.date': '日期',
    'detail.selectMood': '选择心情',
    'detail.note': '备注',
    'detail.notePlaceholder': '写点备注...',
    'detail.save': '保存',
    'detail.clear': '清除',
    'detail.lockedMessage': '数据已加密，请在设置中解锁后编辑。',

    'stats.trendTitle': '趋势与占比',
    'stats.dayLabel': '日',
    'stats.weekLabel': '周',
    'stats.monthLabel': '月',
    'stats.echartsHint': '图表由 ECharts 渲染',
    'stats.canvasHint': '图表由 Canvas 绘制（未集成 ECharts）',
    'stats.noDataTitle': '暂无数据',
    'stats.noDataTip': '去日历页记录今日心情吧',
    'stats.streakLabel': '连续记录天数',
    'stats.streakUnit': '天',
    'stats.allDistribution': '全部分布',
    'stats.rangeDistribution': '范围分布',
    'stats.monthDistribution': '{month} 分布',
    'stats.summaryTitle': '关键指标',
    'stats.summaryAverage': '平均每日记录：{value}',
    'stats.summaryTopMood': '最高频心情：{mood} × {count}',
    'stats.summaryQuiet': '无记录天数：{value}',
    'stats.copySummary': '复制摘要',
    'stats.copySuccess': '摘要已复制',
    'stats.copyFail': '复制失败',
    'stats.rangeTitle': '统计范围',
    'stats.rangeStart': '开始日期',
    'stats.rangeEnd': '结束日期',
    'stats.rangeApply': '应用',
    'stats.rangeReset': '最近30天',
    'stats.lockedMessage': '数据已加密，请先在设置中解锁以查看统计。',

    'search.keywordLabel': '关键词',
    'search.keywordPlaceholder': '搜索备注/日期/表情',
    'search.dateRangeLabel': '日期范围',
    'search.emojiFilterLabel': '表情过滤',
    'search.searchButton': '搜索',
    'search.clearButton': '清空',
    'search.exportJson': '导出JSON',
    'search.exportCsv': '导出CSV',
    'search.resultsLabel': '结果',
    'search.emptyText': '暂无匹配记录，暂时无法导出',
    'search.withNotesOnly': '仅含备注',
    'search.withMoodOnly': '仅有心情',
    'search.emptyMoodOnly': '空心情',
    'search.sortLabel': '排序',
    'search.sortDesc': '按时间最新',
    'search.sortAsc': '按时间最早',
    'search.exportEmpty': '暂无可导出的结果',
    'search.exportSuccess': '已复制到剪贴板',
    'search.exportFail': '复制失败',
    'search.csvSuccess': 'CSV 已复制',
    'search.lockedMessage': '数据已加密，请先解锁以搜索。',

    'settings.weekStart': '周起始日',
    'settings.weekMonday': '周一',
    'settings.weekSunday': '周日',
    'settings.theme': '主题',
    'settings.themeLight': '浅色',
    'settings.themeDark': '深色',
    'settings.accent': '强调色',
    'settings.accentPlaceholder': '输入 #RRGGBB',
    'settings.language': '语言',
    'settings.cloud': '云同步',
    'settings.cloudEnvPlaceholder': '云环境ID（如：xxx-yyy）',
    'settings.saveCloud': '保存云配置',
    'settings.syncNow': '立即同步',
    'settings.emojiSet': '表情集合',
    'settings.emojiPlaceholder': '输入连续的表情字符',
    'settings.save': '保存',
    'settings.reset': '重置默认',
    'settings.colors': '颜色映射',
    'settings.colorPlaceholder': '#RRGGBB',
    'settings.saveColors': '保存颜色',
    'settings.invalidColor': '颜色格式需为#RRGGBB',
    'settings.data': '数据',
    'settings.exportJson': '导出JSON',
    'settings.clearAll': '清除全部',
    'settings.privacy': '隐私政策',
    'settings.import': '导入JSON',
    'settings.importPlaceholder': '贴入导出的 JSON 后点击导入',
    'settings.importPreview': '导入预览',
    'settings.importApply': '导入',
    'settings.importSummary': '新增 {added} 条，更新 {updated} 条，删除 {deleted} 条。是否继续？',
    'settings.importNone': '没有可导入的更新',
    'settings.noValidRecords': '未检测到有效记录',
    'settings.importDone': '导入完成',
    'settings.importError': 'JSON格式错误',
    'settings.jsonRequired': '请输入JSON',
    'settings.invalidMapping': '数据需为对象映射',
    'settings.invalidRecord': '记录 {key} 格式错误',
    'settings.missingTs': '记录 {key} 缺少 ts 字段',
    'settings.invalidTs': '记录 {key} 的 ts 非数字',
    'settings.missingMoodNote': '记录 {key} 缺少 mood/note 字段',
    'settings.invalidMoodType': '记录 {key} 的 mood 需为字符串',
    'settings.invalidNoteType': '记录 {key} 的 note 需为字符串',
    'settings.backup': '云备份',
    'settings.backupNotePlaceholder': '给备份添加备注（可选）',
    'settings.createBackup': '立即备份',
    'settings.refreshBackup': '刷新列表',
    'settings.restore': '恢复',
    'settings.backupEmpty': '暂无备份',
    'settings.backupCount': '记录 {count} 条',
    'settings.backupCreated': '备份成功',
    'settings.backupFailed': '备份失败',
    'settings.loadFailed': '加载失败',
    'settings.restoreConfirm': '确定恢复该备份并覆盖本地较旧记录？',
    'settings.restoreFailed': '恢复失败',
    'settings.cancelText': '取消',
    'settings.encryption': '本地加密',
    'settings.encryptionEnable': '启用加密',
    'settings.encryptionDisable': '关闭加密',
    'settings.encryptionPassword': '密码（至少6位）',
    'settings.encryptionConfirm': '确认密码',
    'settings.encryptionHint': '密码提示（可选）',
    'settings.encryptionUnlock': '解锁数据',
    'settings.encryptionLock': '重新锁定',
    'settings.encryptionStatusOn': '状态：已启用',
    'settings.encryptionStatusOff': '状态：未启用',
    'settings.encryptionLocked': '数据已锁定',
    'settings.encryptionUnlocked': '数据已解锁',
    'settings.encryptionMismatch': '两次密码不一致',
    'settings.encryptionWeak': '密码至少6位',
    'settings.encryptionSet': '加密已启用',
    'settings.encryptionEnableFail': '启用加密失败',
    'settings.encryptionDisableFail': '关闭加密失败',
    'settings.encryptionDisabled': '加密已关闭',
    'settings.encryptionUnlockFail': '解锁失败，请检查密码',
    'settings.encryptionHintLabel': '提示：{hint}',
    'settings.copySuccess': '已复制',
    'settings.clearConfirmTitle': '确认',
    'settings.clearConfirmContent': '确定清除全部心情记录？此操作不可恢复',
    'settings.clearDone': '已清除',
    'settings.syncStart': '同步中...',
    'settings.cloudNotReady': '请先启用并配置云环境',
    'settings.syncSuccess': '同步完成',
    'settings.syncFailed': '同步失败',
    'settings.syncStatus': '本地 {local} / 云端 {remote}',
    'settings.languageZh': '简体中文',
    'settings.languageEn': 'English',
    'settings.unlockFirst': '请先解锁数据再执行此操作。'
  },
  en: {
    'calendar.today': 'Today',
    'calendar.pickTitle': 'Select mood',
    'calendar.addNote': 'Add note',
    'calendar.clear': 'Clear',
    'calendar.stats': 'Stats',
    'calendar.settings': 'Settings',
    'calendar.search': 'Search',
    'calendar.lockedTitle': 'Data encrypted',
    'calendar.lockedHint': 'Unlock local data in Settings before accessing the calendar.',
    'calendar.unlock': 'Unlock in settings',
    'calendar.accessibilityPrevMonth': 'Previous month',
    'calendar.accessibilityNextMonth': 'Next month',
    'calendar.accessibilityMonthPicker': 'Pick month',

    'detail.date': 'Date',
    'detail.selectMood': 'Select mood',
    'detail.note': 'Note',
    'detail.notePlaceholder': 'Write a note...',
    'detail.save': 'Save',
    'detail.clear': 'Clear',
    'detail.lockedMessage': 'Data is encrypted. Unlock it in Settings to edit.',

    'stats.trendTitle': 'Trends & share',
    'stats.dayLabel': 'Day',
    'stats.weekLabel': 'Week',
    'stats.monthLabel': 'Month',
    'stats.echartsHint': 'Charts rendered by ECharts',
    'stats.canvasHint': 'Charts rendered with Canvas (ECharts not bundled)',
    'stats.noDataTitle': 'No data yet',
    'stats.noDataTip': 'Record today’s mood from the calendar.',
    'stats.streakLabel': 'Current streak',
    'stats.streakUnit': 'days',
    'stats.allDistribution': 'All moods',
    'stats.rangeDistribution': 'Range breakdown',
    'stats.monthDistribution': '{month} breakdown',
    'stats.summaryTitle': 'Key insights',
    'stats.summaryAverage': 'Average per day: {value}',
    'stats.summaryTopMood': 'Top mood: {mood} × {count}',
    'stats.summaryQuiet': 'Days without records: {value}',
    'stats.copySummary': 'Copy summary',
    'stats.copySuccess': 'Summary copied',
    'stats.copyFail': 'Copy failed',
    'stats.rangeTitle': 'Range',
    'stats.rangeStart': 'Start date',
    'stats.rangeEnd': 'End date',
    'stats.rangeApply': 'Apply',
    'stats.rangeReset': 'Last 30 days',
    'stats.lockedMessage': 'Data is encrypted. Unlock it in Settings to view stats.',

    'search.keywordLabel': 'Keyword',
    'search.keywordPlaceholder': 'Search notes/date/mood',
    'search.dateRangeLabel': 'Date range',
    'search.emojiFilterLabel': 'Mood filter',
    'search.searchButton': 'Search',
    'search.clearButton': 'Clear',
    'search.exportJson': 'Export JSON',
    'search.exportCsv': 'Export CSV',
    'search.resultsLabel': 'Results',
    'search.emptyText': 'No matching records to export',
    'search.withNotesOnly': 'Notes only',
    'search.withMoodOnly': 'Mood only',
    'search.emptyMoodOnly': 'Empty mood',
    'search.sortLabel': 'Sort',
    'search.sortDesc': 'Newest first',
    'search.sortAsc': 'Oldest first',
    'search.exportEmpty': 'Nothing to export',
    'search.exportSuccess': 'Copied to clipboard',
    'search.exportFail': 'Copy failed',
    'search.csvSuccess': 'CSV copied',
    'search.lockedMessage': 'Data is encrypted. Unlock to search.',

    'settings.weekStart': 'Week start',
    'settings.weekMonday': 'Monday',
    'settings.weekSunday': 'Sunday',
    'settings.theme': 'Theme',
    'settings.themeLight': 'Light',
    'settings.themeDark': 'Dark',
    'settings.accent': 'Accent color',
    'settings.accentPlaceholder': 'Enter #RRGGBB',
    'settings.language': 'Language',
    'settings.cloud': 'Cloud sync',
    'settings.cloudEnvPlaceholder': 'Cloud env ID (e.g. xxx-yyy)',
    'settings.saveCloud': 'Save cloud config',
    'settings.syncNow': 'Sync now',
    'settings.emojiSet': 'Emoji set',
    'settings.emojiPlaceholder': 'Type emojis directly',
    'settings.save': 'Save',
    'settings.reset': 'Reset',
    'settings.colors': 'Color mapping',
    'settings.colorPlaceholder': '#RRGGBB',
    'settings.saveColors': 'Save colors',
    'settings.invalidColor': 'Color must match #RRGGBB',
    'settings.data': 'Data',
    'settings.exportJson': 'Export JSON',
    'settings.clearAll': 'Clear all',
    'settings.privacy': 'Privacy policy',
    'settings.import': 'Import JSON',
    'settings.importPlaceholder': 'Paste exported JSON then import',
    'settings.importPreview': 'Import preview',
    'settings.importApply': 'Import',
    'settings.importSummary': 'Add {added}, update {updated}, delete {deleted}. Continue?',
    'settings.importNone': 'No changes to import',
    'settings.noValidRecords': 'No valid records detected',
    'settings.importDone': 'Import complete',
    'settings.importError': 'Invalid JSON',
    'settings.jsonRequired': 'Please enter JSON',
    'settings.invalidMapping': 'Data must be an object map',
    'settings.invalidRecord': 'Record {key} format invalid',
    'settings.missingTs': 'Record {key} missing ts',
    'settings.invalidTs': 'Record {key} ts must be a number',
    'settings.missingMoodNote': 'Record {key} needs mood or note',
    'settings.invalidMoodType': 'Record {key} mood must be a string',
    'settings.invalidNoteType': 'Record {key} note must be a string',
    'settings.backup': 'Cloud backup',
    'settings.backupNotePlaceholder': 'Optional note for this backup',
    'settings.createBackup': 'Create backup',
    'settings.refreshBackup': 'Refresh list',
    'settings.restore': 'Restore',
    'settings.backupEmpty': 'No backups yet',
    'settings.backupCount': 'Records {count}',
    'settings.backupCreated': 'Backup created',
    'settings.backupFailed': 'Backup failed',
    'settings.loadFailed': 'Load failed',
    'settings.restoreConfirm': 'Restore this backup and overwrite older local records?',
    'settings.restoreFailed': 'Restore failed',
    'settings.cancelText': 'Cancel',
    'settings.encryption': 'Local encryption',
    'settings.encryptionEnable': 'Enable encryption',
    'settings.encryptionDisable': 'Disable encryption',
    'settings.encryptionPassword': 'Password (min 6 chars)',
    'settings.encryptionConfirm': 'Confirm password',
    'settings.encryptionHint': 'Password hint (optional)',
    'settings.encryptionUnlock': 'Unlock data',
    'settings.encryptionLock': 'Lock again',
    'settings.encryptionStatusOn': 'Status: enabled',
    'settings.encryptionStatusOff': 'Status: disabled',
    'settings.encryptionLocked': 'Data locked',
    'settings.encryptionUnlocked': 'Data unlocked',
    'settings.encryptionMismatch': 'Passwords do not match',
    'settings.encryptionWeak': 'Password must be at least 6 characters',
    'settings.encryptionSet': 'Encryption enabled',
    'settings.encryptionEnableFail': 'Failed to enable encryption',
    'settings.encryptionDisableFail': 'Failed to disable encryption',
    'settings.encryptionDisabled': 'Encryption disabled',
    'settings.encryptionUnlockFail': 'Unlock failed, check password',
    'settings.encryptionHintLabel': 'Hint: {hint}',
    'settings.copySuccess': 'Copied',
    'settings.clearConfirmTitle': 'Confirm',
    'settings.clearConfirmContent': 'Clear all records? This cannot be undone.',
    'settings.clearDone': 'Cleared',
    'settings.syncStart': 'Syncing...',
    'settings.cloudNotReady': 'Enable cloud and set env ID first',
    'settings.syncSuccess': 'Sync completed',
    'settings.syncFailed': 'Sync failed',
    'settings.syncStatus': 'Local {local} / Remote {remote}',
    'settings.languageZh': '简体中文',
    'settings.languageEn': 'English',
    'settings.unlockFirst': 'Unlock data before performing this action.'
  }
}

function getCurrentLang() {
  const s = settings.getSettings()
  return s.language || 'zh'
}

function format(template, params) {
  if (!template || typeof template !== 'string') return template
  if (!params) return template
  return template.replace(/\{(\w+)\}/g, (all, key) => (params[key] !== undefined ? params[key] : all))
}

function t(key, params) {
  const lang = getCurrentLang()
  const dict = DICT[lang] || {}
  const fallback = DICT.zh || {}
  const template = dict[key] !== undefined ? dict[key] : fallback[key]
  return format(template !== undefined ? template : key, params)
}

function getScope(scope) {
  const lang = getCurrentLang()
  const dict = DICT[lang] || {}
  const fallback = DICT.zh || {}
  const res = {}
  const prefix = scope ? scope + '.' : ''
  Object.keys(fallback).forEach(key => {
    if (key.startsWith(prefix)) {
      const shortKey = key.substring(prefix.length)
      res[shortKey] = fallback[key]
    }
  })
  Object.keys(dict).forEach(key => {
    if (key.startsWith(prefix)) {
      const shortKey = key.substring(prefix.length)
      res[shortKey] = dict[key]
    }
  })
  return res
}

function getLanguages() {
  const lang = getCurrentLang()
  const dict = DICT[lang] || {}
  const fallback = DICT.zh || {}
  return [
    { value: 'zh', label: dict['settings.languageZh'] || fallback['settings.languageZh'] || '简体中文' },
    { value: 'en', label: dict['settings.languageEn'] || fallback['settings.languageEn'] || 'English' }
  ]
}

module.exports = {
  t,
  getScope,
  getLanguages,
  getCurrentLang
}
